<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="morisa"><meta name="copyright" content="morisa"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>OpenGL 2 | Little Web</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.24/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"></script><script>document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "$", right: "$", display: false},
      {left: "\\(", right: "\\)", display: false},
      {left: "\\[", right: "\\]", display: true}
    ]
  });
});</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"morisa66.github.io","root":"/","title":"难为君子|不做小人","version":"1.5.1","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><meta name="description" content="本文参考：https:&#x2F;&#x2F;learnopengl.com&#x2F;。 长文预警 (〃&#39;▽&#39;〃) (｡･ω･｡) φ(&gt;ω&lt;*) Advance Depth testing 深度缓冲会以 16、24 或 32 位 float 的形式储存每个片段中的深度值，通常和颜色缓冲有着一样的宽度和高度。 大部分的系统中，深度缓冲的精度都是 24 位的。 当深度测试(Depth Testing)被">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenGL 2">
<meta property="og:url" content="https://morisa66.github.io/2021/01/21/OpenGL2/index.html">
<meta property="og:site_name" content="Little Web">
<meta property="og:description" content="本文参考：https:&#x2F;&#x2F;learnopengl.com&#x2F;。 长文预警 (〃&#39;▽&#39;〃) (｡･ω･｡) φ(&gt;ω&lt;*) Advance Depth testing 深度缓冲会以 16、24 或 32 位 float 的形式储存每个片段中的深度值，通常和颜色缓冲有着一样的宽度和高度。 大部分的系统中，深度缓冲的精度都是 24 位的。 当深度测试(Depth Testing)被">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/z_buffer.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/stencil_buffer.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/border.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/grass.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/window.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/winding.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/FBO.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/post_processing.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/skybox.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/reflect.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/binding_points.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/geometry.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/instance.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/sample.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/sample1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/sample2.png">
<meta property="article:published_time" content="2021-01-21T12:13:06.000Z">
<meta property="article:modified_time" content="2021-01-22T15:41:17.000Z">
<meta property="article:author" content="morisa">
<meta property="article:tag" content="CPP">
<meta property="article:tag" content="OpenGL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/z_buffer.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="morisa"><img width="96" loading="lazy" src="/imgs/avatar.jpg" alt="morisa"></a><div class="site-author-name"><a href="/about/">morisa</a></div><a class="site-name" href="/about/site.html">Little Web</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">29</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">4</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">15</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/morisa66" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/morisa-48" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/289542802" title="B站" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/morisa66" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="morisa66@outlook.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#advance"><span class="toc-number">1.</span> <span class="toc-text">Advance</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#depth-testing"><span class="toc-number">1.1.</span> <span class="toc-text">Depth testing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stencil-test"><span class="toc-number">1.2.</span> <span class="toc-text">Stencil Test</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#blending"><span class="toc-number">1.3.</span> <span class="toc-text">Blending</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#face-culling"><span class="toc-number">1.4.</span> <span class="toc-text">Face culling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#framebuffers"><span class="toc-number">1.5.</span> <span class="toc-text">FrameBuffers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cubemap"><span class="toc-number">1.6.</span> <span class="toc-text">Cubemap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#buffer"><span class="toc-number">1.7.</span> <span class="toc-text">Buffer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#advanced-glsl"><span class="toc-number">1.8.</span> <span class="toc-text">Advanced GLSL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#geometry-shader"><span class="toc-number">1.9.</span> <span class="toc-text">Geometry Shader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#instancing"><span class="toc-number">1.10.</span> <span class="toc-text">Instancing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#anti-aliasing"><span class="toc-number">1.11.</span> <span class="toc-text">Anti Aliasing</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://morisa66.github.io/2021/01/21/OpenGL2/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="morisa"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Little Web"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">OpenGL 2</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2021-01-21 20:13:06" itemprop="dateCreated datePublished" datetime="2021-01-21T20:13:06+08:00">2021-01-21</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2021-01-22 23:41:17" itemprop="dateModified" datetime="2021-01-22T23:41:17+08:00">2021-01-22</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/Graphics/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Graphics</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/CPP/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">CPP</span></a><a class="tag" href="/tags/OpenGL/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">OpenGL</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><p>本文参考：https://learnopengl.com/。</p>
<p>长文预警 (〃'▽'〃) (｡･ω･｡) φ(&gt;ω&lt;*)</p>
<h1 id="advance">Advance</h1>
<h2 id="depth-testing">Depth testing</h2>
<p>深度缓冲会以 16、24 或 32 位 float 的形式储存每个片段中的深度值，通常和颜色缓冲有着一样的宽度和高度。</p>
<p>大部分的系统中，深度缓冲的精度都是 24 位的。</p>
<p>当深度测试(Depth Testing)被启用，OpenGL会将一个片段的深度值与深度缓冲的内容进行对比，执深度测试。如果测试通过，深度缓冲将会更新为新的深度值；如果测试失败，片段会被丢弃。</p>
<p>深度缓冲是在片段着色器运行之后，在屏幕空间中运行的。屏幕空间坐标与 <code>glViewport</code> 定义的视口密切相关，可以使用 <strong>gl_FragCoord</strong> 从片段着色器中直接访问，x 和 y 分量代表了片段的屏幕空间坐标，(0, 0)位于左下角。</p>
<p><strong>gl_FragCoord</strong> 的 z 分量，是片段真正的深度值，也是与深度缓冲内容所对比的那个值。</p>
<blockquote>
<p>大部分 GPU 都提供提前深度测试(Early Depth Testing)的硬件特性，允许深度测试在片段着色器之前运行。</p>
<p>只要清楚一个片段永远不会是可见的（在其他物体之后），就能提前丢弃这个片段。</p>
<p>片段着色器开销很大，应该尽可能避免运行。当使用提前深度测试时，片段着色器的限制是不能写入片段的深度值。如果片段着色器对它的深度值进行了写入，就不能提前深度测试，OpenGL 不能提前知道深度值。</p>
</blockquote>
<p>深度测试默认禁用，用 <strong>GL_DEPTH_TEST</strong> 选项来启用：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_DEPTH_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>当启用深度测试后，如果一个片段通过了深度测试，OpenGL 会在深度缓冲中储存该片段的 z 值；如果没有通过，会丢弃该片段。如果启用了深度缓冲，应该在每个渲染迭代之前使用 <strong>GL_DEPTH_BUFFER_BIT</strong> 来清除深度缓冲，否则会使用上一次渲染迭代中的写入的深度值。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT <span class="token operator">|</span> GL_DEPTH_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>某些情况下需要对所有片段都执行深度测试并丢弃相应的片段，但不希望更新深度缓冲，禁用深度缓冲的写入。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glDepthMask</span><span class="token punctuation">(</span>GL_FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 深度测试被启用才有效。</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>OpenGL 允许修改深度测试使用的比较运算符，来控制什么时候该通过或丢弃一个片段，什么时候更新深度缓冲。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glDepthFunc</span><span class="token punctuation">(</span>GL_LESS<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 默认使用</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<ul>
<li>GL_ALWAYS：永远通过深度测试</li>
<li>GL_NEVER：永远不通过深度测试</li>
<li>GL_LESS：在片段深度值小于缓冲的深度值时通过测试</li>
<li>GL_EQUAL：在片段深度值等于缓冲区的深度值时通过测试</li>
<li>GL_LEQUAL： 在片段深度值小于等于缓冲区的深度值时通过测试</li>
<li>GL_GREATER：在片段深度值大于缓冲区的深度值时通过测试</li>
<li>GL_NOTEQUAL：在片段深度值不等于缓冲区的深度值时通过测试</li>
<li>GL_GEQUAL：在片段深度值大于等于缓冲区的深度值时通过测试</li>
</ul>
</blockquote>
<p>下面的线性方程将 z 值变换到了<code>[0,1]</code>之间的深度值： <span class="math display">\[
depth = \frac{z-near}{far-near}
\]</span></p>
<blockquote>
<p>将非常近的物体的深度值设置为接近 0，非常接近远平面的的深度值会非常接近1。</p>
</blockquote>
<p>实际使用时，需要 z 很小（距离很近）的时候提供较大的精度值，需要一个非线性变换： <span class="math display">\[
depth = \frac{z^{-1}-near^{-1}}{far^{-1}-near^{-1}}
\]</span> 深度缓冲中的值在屏幕空间中不是线性的（下面是 near = 0.1、far = 100 的图像）：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">near <span class="token operator">=</span> <span class="token number">0.1</span>
far <span class="token operator">=</span> <span class="token number">100</span>
z <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">arange</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
depth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> z <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">/</span> near<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> far <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">/</span> near<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span><span class="token function">plot</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> depth<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/z_buffer.png" / loading="lazy"></p>
<p><strong>深度值很大一部分是由很小的 z 值所决定的，这给了近处的物体很大的深度精度。</strong></p>
<p>内建 <strong>gl_FragCoord</strong> 向量的 z 值包含了那个特定片段的深度值，可以可视化深度值。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>gl_FragCoord<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>两个平面或三角形非常紧密地平行排列在一起时会发生<strong>深度冲突</strong>(Z-fighting)。深度缓冲没有足够的精度来决定两个形状哪个在前面，结果就不断地在切换前后顺序，导致奇怪现象。解决方法如下：</p>
<ul>
<li>不要把多个物体摆得太靠近，防止一些三角形重叠。</li>
<li>将近平面设置远一些。</li>
<li>使用更高精度的深度缓冲。</li>
</ul>
<h2 id="stencil-test">Stencil Test</h2>
<p>当片段着色器处理完一个片段之后，<strong>模板测试</strong>(Stencil Test)会开始执行；模板测试可能会丢弃片段，保留的片段会进入深度测试。</p>
<p>模板测试是根据<strong>模板缓冲</strong>(Stencil Buffer)进行的。每个模板值(Stencil Value)是8位的，可以将这些模板值设置为想要的值，然后当某一个片段有某一个模板值的时候，就可以选择丢弃或保留这个片段。</p>
<blockquote>
<p>每个窗口库都需要配置一个模板缓冲。GLFW自动做了这件事，，其它窗口库可能不会默认创建一个模板库。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/stencil_buffer.png" / loading="lazy"></p>
<p>模板缓冲首先被清除为 0，之后在模板缓冲中使用1填充了部分，场景中片段只在片段的模板值为1的时候被渲染。</p>
<p>启用 <strong>GL_STENCIL_TEST</strong> 来启用模板测试：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_STENCIL_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在每次迭代之前清除模板缓冲：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT <span class="token operator">|</span> GL_DEPTH_BUFFER_BIT <span class="token operator">|</span> GL_STENCIL_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>glStencilMask</code> 设置一个位掩码(Bitmask)，与将要写入缓冲的模板值进行与(AND)运算：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glStencilMask</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每一位写入模板缓冲时都保持原样</span>
<span class="token function">glStencilMask</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每一位在写入模板缓冲时都会变成0（禁用写入）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glStencilFunc</span><span class="token punctuation">(</span>GLenum func<span class="token punctuation">,</span> GLint ref<span class="token punctuation">,</span> GLuint mask<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<ul>
<li><code>func</code>：设置模板测试函数，会应用到已储存的模板值和 <code>glStencilFunc</code> 函数的<code>ref</code>值上，可用函数与深度缓冲类似。</li>
<li><code>ref</code>：模板测试的参考值，模板缓冲的内容将会与这个值进行比较。</li>
<li><code>mask</code>：会与参考值和储存的模板值在测试比较它们之前进行与(AND)运算，默认所有位都为 1。</li>
</ul>
</blockquote>
<p>上面的例子中：片段的模板值等于(<code>GL_EQUAL</code>)参考值 1，会通过测试被绘制，否则被丢弃。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glStencilFunc</span><span class="token punctuation">(</span>GL_EQUAL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glStencilOp</span><span class="token punctuation">(</span>GLenum sfail<span class="token punctuation">,</span> GLenum dpfail<span class="token punctuation">,</span> GLenum dppass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 默认: glStencilOp(GL_KEEP, GL_KEEP, GL_KEEP);</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<ul>
<li><code>sfail</code>：模板测试失败时采取的行为。</li>
<li><code>dpfail</code>：模板测试通过，但深度测试失败时采取的行为。</li>
<li><code>dppass</code>：模板测试和深度测试都通过时采取的行为。</li>
</ul>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">行为</th>
<th style="text-align: left;">描述</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">GL_KEEP</td>
<td style="text-align: left;">保持当前储存的模板值</td>
</tr>
<tr class="even">
<td style="text-align: left;">GL_ZERO</td>
<td style="text-align: left;">将模板值设置为0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">GL_REPLACE</td>
<td style="text-align: left;">将模板值设置为<code>glStencilFunc</code>函数设置的<code>ref</code>值</td>
</tr>
<tr class="even">
<td style="text-align: left;">GL_INCR</td>
<td style="text-align: left;">如果模板值小于最大值则将模板值加1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">GL_INCR_WRAP</td>
<td style="text-align: left;">与GL_INCR一样，但如果模板值超过了最大值则归零</td>
</tr>
<tr class="even">
<td style="text-align: left;">GL_DECR</td>
<td style="text-align: left;">如果模板值大于最小值则将模板值减1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">GL_DECR_WRAP</td>
<td style="text-align: left;">与GL_DECR一样，但如果模板值小于0则将其设置为最大值</td>
</tr>
<tr class="even">
<td style="text-align: left;">GL_INVERT</td>
<td style="text-align: left;">按位翻转当前的模板缓冲值</td>
</tr>
</tbody>
</table>
</blockquote>
<p><strong>物体边框</strong></p>
<p>创建一个边框颜色片段着色器：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0.26</span><span class="token punctuation">,</span> <span class="token number">0.12</span><span class="token punctuation">,</span> <span class="token number">0.34</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>启用模板测试</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_STENCIL_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glStencilFunc</span><span class="token punctuation">(</span>GL_NOTEQUAL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glStencilOp</span><span class="token punctuation">(</span>GL_KEEP<span class="token punctuation">,</span> GL_KEEP<span class="token punctuation">,</span> GL_REPLACE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<blockquote>
<ul>
<li>模板测试和深度测试有一个测试失败：保留当前储存在模板缓冲中的值。</li>
<li>模板测试和深度测试都通过：储存的模板值设置为参考值，用 <code>glStencilFunc</code> 设置为 1。</li>
</ul>
</blockquote>
<p>在 rendering loop 中清除模板缓冲。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT <span class="token operator">|</span> GL_DEPTH_BUFFER_BIT <span class="token operator">|</span> GL_STENCIL_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>绘制不需要边框的物体：( 禁用模板缓冲，不更新)</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">shader<span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glStencilMask</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>planeVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> texturePlane<span class="token punctuation">)</span><span class="token punctuation">;</span>
shader<span class="token punctuation">.</span><span class="token function">setMat4</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> glm<span class="token operator">::</span><span class="token function">mat4</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>绘制需要边框的物体：(将模板缓冲清除为0，对所有绘制的片段，将模板值更新为1)</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">shader<span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 所有的片段都更新模板缓冲</span>
<span class="token function">glStencilFunc</span><span class="token punctuation">(</span>GL_ALWAYS<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  启用模板缓冲写入</span>
<span class="token function">glStencilMask</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>cubeVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glActiveTexture</span><span class="token punctuation">(</span>GL_TEXTURE0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> textureCube<span class="token punctuation">)</span><span class="token punctuation">;</span>
model <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">translate</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> glm<span class="token operator">::</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
shader<span class="token punctuation">.</span><span class="token function">setMat4</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>使用 <strong>GL_ALWAYS</strong> 模板测试函数，保证需要绘制物体的每个片段都会将模板缓冲的模板值更新为1。</p>
</blockquote>
<p>绘制放大的物体：（禁用模板写入和深度测试）</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">border_shader<span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glStencilFunc</span><span class="token punctuation">(</span>GL_NOTEQUAL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glStencilMask</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glDisable</span><span class="token punctuation">(</span>GL_DEPTH_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> scale <span class="token operator">=</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>cubeVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> textureCube<span class="token punctuation">)</span><span class="token punctuation">;</span>
model <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">mat4</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
model <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">translate</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> glm<span class="token operator">::</span><span class="token function">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
model <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">scale</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> glm<span class="token operator">::</span><span class="token function">vec3</span><span class="token punctuation">(</span>scale<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> scale<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
border_shader<span class="token punctuation">.</span><span class="token function">setMat4</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>使用 <strong>GL_NOTEQUAL</strong>模板测试函数，保证只绘制需要绘制边框的物体的模板值不为 1 的部分。</p>
<p>禁用深度测试，让放大的地方（边框），不会被不需要绘制边框的物体覆盖。</p>
</blockquote>
<p>重启深度缓冲和模板测试：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glStencilMask</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glStencilFunc</span><span class="token punctuation">(</span>GL_ALWAYS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glEnable</span><span class="token punctuation">(</span>GL_DEPTH_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>下面是测试的情况：</p>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/border.png" style="zoom:50%;" / loading="lazy"></p>
<h2 id="blending">Blending</h2>
<p>透明是由 alpha 值来控制的。</p>
<p><strong>片段丢弃</strong></p>
<p>使用 RGBA 加载含 alpha 通道的图像，在着色器中简单判断一下就行。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">vec4</span> texColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>texture1<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>texColor<span class="token punctuation">.</span>a <span class="token operator">&lt;</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
    <span class="token keyword">discard</span><span class="token punctuation">;</span>
FragColor <span class="token operator">=</span> texColor<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>OpenGL 默认不知道怎么处理 alpha 值，不知道什么时候丢弃片段。</p>
<p><code>discard</code> 指令被调用，会保证片段不会被进一步处理，不会进入颜色缓冲。能够在片段着色器中检测一个片段的 alpha 值是否低于某个阈值，满足条件就丢弃这个片段，</p>
</blockquote>
<p>使用透明值，纹理图像的顶部将会与底部边缘的纯色值进行插值，结果是一个半透明的有色边框。</p>
<p>使用 alpha 纹理时，环绕方式设置为 <strong>GL_CLAMP_TO_EDGE</strong>。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_WRAP_S<span class="token punctuation">,</span> format <span class="token operator">==</span> GL_RGBA <span class="token operator">?</span> GL_CLAMP_TO_EDGE <span class="token operator">:</span> GL_REPEAT<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_WRAP_T<span class="token punctuation">,</span> format <span class="token operator">==</span> GL_RGBA <span class="token operator">?</span> GL_CLAMP_TO_EDGE <span class="token operator">:</span> GL_REPEAT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/grass.png" alt="image-20210315161038560" style="zoom:50%;" / loading="lazy"></p>
<p><strong>颜色混合</strong></p>
<p>启用 <strong>GL_BLEND</strong> 来启用混合。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_BLEND<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><span class="math display">\[
C_{RES}=C_{SRC}*P_{SRC}+C_{DST}*P_{DST}
\]</span></p>
<blockquote>
<ul>
<li><span class="math inline">\(C_{SRC}\)</span>：纹理颜色向量。</li>
<li><span class="math inline">\(P_{SRC}\)</span>：alpha 值对<span class="math inline">\(C_{SRC}\)</span>的影响。</li>
<li><span class="math inline">\(C_{DST}\)</span>：颜色缓冲中的颜色向量。</li>
<li><span class="math inline">\(P_{DST}\)</span>：alpha 值对<span class="math inline">\(C_{DST}\)</span>的影响。</li>
</ul>
</blockquote>
<p>用下面的函数设置上面的参数。（<code>glBlendColor</code> 设置颜色常量 <span class="math inline">\(C_{CONST}\)</span>）</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBlendFunc</span><span class="token punctuation">(</span>GLenum sfactor<span class="token punctuation">,</span> GLenum dfactor<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<ul>
<li>GL_ZERO：<span class="math inline">\(0\)</span></li>
<li>GL_ONE：<span class="math inline">\(1\)</span></li>
<li>GL_SRC_COLOR：<span class="math inline">\(C_{SRC}\)</span></li>
<li>GL_ONE_MINUS_SRC_COLOR：<span class="math inline">\(1-C_{SRC}\)</span></li>
<li>GL_DST_COLOR：<span class="math inline">\(C_{DST}\)</span></li>
<li>GL_ONE_MINUS_DST_COLOR：<span class="math inline">\(1-C_{DST}\)</span></li>
<li>GL_SRC_ALPHA：<span class="math inline">\(C_{SRC}.{\alpha}\)</span></li>
<li>GL_ONE_MINUS_SRC_ALPHA：<span class="math inline">\(1-C_{SRC}.{\alpha}\)</span></li>
<li>GL_DST_ALPHA：<span class="math inline">\(C_{DST}.{\alpha}\)</span></li>
<li>GL_ONE_MINUS_DST_ALPHA：<span class="math inline">\(1-C_{DST}.{\alpha}\)</span></li>
<li>GL_CONSTANT_COLOR：<span class="math inline">\(C_{CONST}\)</span></li>
<li>GL_ONE_MINUS_CONSTANT_COLOR：<span class="math inline">\(1-C_{CONST}\)</span></li>
<li>GL_CONSTANT_ALPHA：<span class="math inline">\(C_{CONST}.{\alpha}\)</span></li>
<li>GL_ONE_MINUS_CONSTANT_ALPHA：<span class="math inline">\(1-C_{CONST}.{\alpha}\)</span></li>
</ul>
</blockquote>
<p>比如<span class="math inline">\(P_{SRC} = C_{SRC}.{\alpha},~~ P_{DST} = 1-C_{SRC}.{\alpha}\)</span></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBlendFunc</span><span class="token punctuation">(</span>GL_SRC_ALPHA<span class="token punctuation">,</span> GL_ONE_MINUS_SRC_ALPHA<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>使用 <code>glBlendFuncSeparate</code> 为 RGB 和 alpha 通道设置不同的选项：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBlendFuncSeparate</span><span class="token punctuation">(</span>GL_SRC_ALPHA<span class="token punctuation">,</span> GL_ONE_MINUS_SRC_ALPHA<span class="token punctuation">,</span> GL_ONE<span class="token punctuation">,</span> GL_ZERO<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><code>glBlendEquation(GLenum mode)</code>允许设置运算符</p>
<blockquote>
<ul>
<li>GL_FUNC_ADD：默认。</li>
<li>GL_FUNC_SUBTRACT：相减。</li>
<li>GL_FUNC_REVERSE_SUBTRACT：交换再相减。</li>
</ul>
</blockquote>
<p><strong>半透明纹理</strong></p>
<p>始化时启用混合，并设定相应的混合函数：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_BLEND<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBlendFunc</span><span class="token punctuation">(</span>GL_SRC_ALPHA<span class="token punctuation">,</span> GL_ONE_MINUS_SRC_ALPHA<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启用了混合，不需要丢弃片段，把片段着色器还原：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">FragColor <span class="token operator">=</span>  <span class="token function">texture</span><span class="token punctuation">(</span>texture1<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意到最前面的窗户遮挡了后面的窗户（下图左）。</p>
<blockquote>
<p>深度测试和混合一起使用，当写入深度缓冲时，深度缓冲不会检查片段是否是透明，所以透明部分会和其它值一样写入到深度缓冲中。即使透明的部分应该显示背后的窗户，深度测试仍然丢弃了它们。</p>
<p>对于草贴图这种全透明的物体，可以选择丢弃透明的片段而不是混合它们，这样就没有深度问题。</p>
</blockquote>
<p>绘制一个有不透明和透明物体的场景顺序：</p>
<ul>
<li>绘制所有不透明物体。</li>
<li>观察者视角获取物体的距离，对所有透明物体按距离排序。</li>
<li>按顺序绘制所有透明物体（先绘制远处的）。</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">std<span class="token operator">::</span>map<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">,</span> glm<span class="token operator">::</span>vec3<span class="token operator">></span> _map<span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>windowVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> textureWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">arraySize</span><span class="token punctuation">(</span>window_pos<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	_map<span class="token punctuation">[</span>glm<span class="token operator">::</span><span class="token function">length</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span>  window_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> window_pos<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> it <span class="token operator">=</span> _map<span class="token punctuation">.</span><span class="token function">rbegin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> _map<span class="token punctuation">.</span><span class="token function">rend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	model <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">mat4</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	model <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">translate</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> it<span class="token operator">-></span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
	shader<span class="token punctuation">.</span><span class="token function">setMat4</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<ul>
<li>map 会按照 Key 对值排序（小到大）。</li>
<li>逆序遍历 map，auto 实际上是 <code>std::map&lt;float,glm::vec3&gt;::reverse_iterator</code>，绘制物体。</li>
</ul>
</blockquote>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/window.png" / loading="lazy"></p>
<h2 id="face-culling">Face culling</h2>
<p>只渲染观察者能看到的面，丢弃剩下的面；何一个面都有两侧，面向和背对观察者的面，只绘制面向观察者的面。</p>
<p>OpenGL 能检查所有面向(Front Facing)观察者的面，并渲染它们；丢弃那些背向(Back Facing)的面，节省片段着色器调用（开销很大）。OpenGL使用了一个技巧，分析顶点数据的<strong>环绕顺序</strong>。</p>
<blockquote>
<p>下面是按照顺时针和逆时针定义的三角形：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">float</span> vertices<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> 
<span class="token punctuation">&#123;</span>
    <span class="token comment">// 顺时针</span>
    vertices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 1</span>
    vertices<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 2</span>
    vertices<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 3</span>
    <span class="token comment">// 逆时针</span>
    vertices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 1</span>
    vertices<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 3</span>
    vertices<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment">// 2  </span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/winding.png" alt="winding" style="zoom:67%;" / loading="lazy"></p>
<p>默认环绕顺序为逆时针定义的三角形为正向三角形（观察者看过去为逆时针）。</p>
<p>会剔除所有顺时针渲染的面（背向观察者的面）。</p>
</blockquote>
<p>启用 OpenGL 的 <strong>GL_CULL_FACE</strong> 选项来开启面剔除。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_CULL_FACE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>只对立方体这样的封闭形状有效，绘制草之类的物体，要禁用面剔除，因为其正向面和背向面都应该可见。</p>
</blockquote>
<p>调用 <code>glCullFace</code> 改变需要剔除的面的类型。</p>
<blockquote>
<ul>
<li><code>GL_BACK</code>：只剔除背面（默认）。</li>
<li><code>GL_FRONT</code>：只剔除正面。</li>
<li><code>GL_FRONT_AND_BACK</code>：剔除正面和背面。</li>
</ul>
</blockquote>
<p>将顺时针的面定义为正向面：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glFrontFace</span><span class="token punctuation">(</span>GL_CW<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认GL_CCW代表是逆时针</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>面剔除可以很好的提高程序性能，但应该明确什么物体应该面剔除，什么物体禁止面剔除。</strong></p>
<h2 id="framebuffers">FrameBuffers</h2>
<p>帧缓冲FrameBuffers = 颜色缓冲ColorBuffers + 深度缓冲DepthBuffer + 模板缓冲StencilBuffer</p>
<p>目前的操作都是在默认帧缓冲的渲染缓冲上进行的，默认的帧缓冲是在创建窗口的时候生成和配置的。</p>
<p>使用 <code>glGenFramebuffers</code> 创建帧缓冲对象FBO（Frame Buffer Object）。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> FBO<span class="token punctuation">;</span>
<span class="token function">glGenFramebuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>FBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>使用 <code>glBindFramebuffer</code> 绑定帧缓冲。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> FBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>绑定到 <strong>GL_FRAMEBUFFER</strong> 目标之后，所有读取和写入帧缓冲的操作将会影响当前绑定的帧缓冲。</p>
<blockquote>
<p>可以使用 <strong>GL_READ_FRAMEBUFFER</strong> 或 <strong>GL_DRAW_FRAMEBUFFER</strong>一个帧缓冲分别绑定到读取或写入目标。</p>
<ul>
<li>绑定到 <strong>GL_READ_FRAMEBUFFER</strong> 的帧缓冲将会使用在读取操作中。</li>
<li>绑定到 <strong>GL_DRAW_FRAMEBUFFER</strong> 的帧缓冲将会被用作渲染、清除等写入操作的目标。</li>
</ul>
<p>大部分情况不需要区分，使用 <strong>GL_FRAMEBUFFER</strong> 绑定。</p>
</blockquote>
<p><strong>完整的帧缓冲</strong></p>
<ul>
<li>至少有一个缓冲（颜色、深度、模板缓冲）。</li>
<li>至少有一个颜色附件(Attachment)。</li>
<li>所有的附件都必须是完整的（保留了内存）。</li>
<li>每个缓冲都应该有相同的样本数。</li>
</ul>
<p>下面的代码可以判断帧缓冲是否完整：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">glCheckFramebufferStatus</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">)</span> <span class="token operator">==</span> GL_FRAMEBUFFER_COMPLETE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>之后所有的渲染操作将会渲染到当前绑定帧缓冲的附件中。</p>
<p>当前绑定的帧缓冲不是默认帧缓冲，渲染指令不会对窗口的视觉输出有任何影响。渲染到一个不同帧缓冲即<strong>离屏渲染</strong>(Off-screen Rendering)。要让所有渲染操作在主窗口中有视觉效果，要再次激活默认帧缓冲，并绑定到 0。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>完成所有的帧缓冲操作之后，要删除这个帧缓冲对象。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glDeleteFramebuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>FBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>附件是一个内存位置，它能作为帧缓冲的一个缓冲。</p>
<p>当创建一个附件的时候有两个选项：纹理或渲染缓冲对象(Renderbuffer Object)。</p>
</blockquote>
<p><strong>纹理附件</strong></p>
<p>把一个纹理附加到帧缓冲，所有渲染指令会写入到这个纹理中。使用纹理的优点是，可以把所有渲染操作的结果将会被储存在一个纹理图像中，可以在着色器中很方便地使用。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> texture<span class="token punctuation">;</span>
<span class="token function">glGenTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> GL_UNSIGNED_BYTE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<ul>
<li>维度设置为了屏幕大小（不是必须的）。</li>
<li>data 参数设置为 NULL，仅仅分配内存而不填充。</li>
<li>大多数情况下不需要关心环绕方式或多级渐远纹理。</li>
<li>要屏幕渲染到一个更小或更大的纹理上，需要在渲染到帧缓冲之前再次调用冲<code>glViewport</code>，使用纹理的新维度作为参数，否则只有小部分的纹理或屏幕会被渲染到这个纹理上。</li>
</ul>
</blockquote>
<p>附加到帧缓冲上：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glFramebufferTexture2D</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT0<span class="token punctuation">,</span> GL_TEXTURE_2D<span class="token punctuation">,</span> texture<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<ul>
<li>param1：target 帧缓冲的目标（绘制、读取）。</li>
<li>param2：attachment 件类型（可以添加多个），这里是颜色附件。</li>
<li>param3：textarget 附加的纹理类型。</li>
<li>param4：texture 附加的纹理本身。</li>
<li>param5：level 多级渐远纹理的级别（保留0）。</li>
</ul>
</blockquote>
<p>附加一个深度缓冲纹理：</p>
<ul>
<li>附件类型：<strong>GL_DEPTH_ATTACHMENT</strong></li>
<li>纹理格式(Format)、内部格式(Internalformat)：<strong>GL_DEPTH_COMPONENT</strong></li>
</ul>
<p>附加一个深度模板纹理：</p>
<ul>
<li>附件类型： <strong>GL_STENCIL_ATTACHMENT</strong></li>
<li>纹理格式(Format)、内部格式(Internalformat)：<strong>GL_STENCIL_INDEX</strong></li>
</ul>
<p>可以将深度缓冲和模板缓冲附加为一个单独的纹理。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_DEPTH24_STENCIL8<span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
             GL_DEPTH_STENCIL<span class="token punctuation">,</span>GL_UNSIGNED_INT_24_8<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glFramebufferTexture2D</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_DEPTH_STENCIL_ATTACHMENT<span class="token punctuation">,</span> GL_TEXTURE_2D<span class="token punctuation">,</span> texture<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>渲染缓冲对象</strong></p>
<p>渲染缓冲对象（RenderBuffer Object）是一个真正的缓冲，即一系列的字节、整数、像素，它会将数据储存为 OpenGL 原生渲染格式，是为离屏渲染到帧缓冲优化过的。</p>
<p>创建一个渲染缓冲对象。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> RBO<span class="token punctuation">;</span>
<span class="token function">glGenRenderbuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>RBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>绑定渲染缓冲对象。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBindRenderbuffer</span><span class="token punctuation">(</span>GL_RENDERBUFFER<span class="token punctuation">,</span> RBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>由于渲染缓冲对象通常是只写的，会经常用于深度和模板附件，因为一般不需要从深度和模板缓冲中读取值，只关心深度和模板测试。</p>
<p>用 <code>glRenderbufferStorage</code> 创建深度和模板缓冲。</p>
<p>创建一个渲染缓冲对象是专门被设计作为图像使用的，而不是纹理作为通用数据缓冲。</p>
<p>这里选择 <strong>GL_DEPTH24_STENCIL8</strong> 作为内部格式，它封装了 24 位的深度和 8 位的模板缓冲。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glRenderbufferStorage</span><span class="token punctuation">(</span>GL_RENDERBUFFER<span class="token punctuation">,</span> GL_DEPTH24_STENCIL8<span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>附加这个渲染缓冲对象。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glFramebufferRenderbuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_DEPTH_STENCIL_ATTACHMENT<span class="token punctuation">,</span> GL_RENDERBUFFER<span class="token punctuation">,</span> RBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>渲染到纹理</strong></p>
<p>这里将场景渲染到一个附加到帧缓冲对象上的颜色纹理中，在整个屏幕的四边形上绘制这个纹理。</p>
<p>需要一个覆盖屏幕的平面和平面 VAO：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">float</span> surface<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> 
<span class="token punctuation">&#123;</span> 
    <span class="token comment">// positions   // texCoords</span>
    <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>
     <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>

    <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span>
     <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>
     <span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span>  <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> surfaceVAO<span class="token punctuation">,</span> surfaceVBO<span class="token punctuation">;</span>
<span class="token function">glGenVertexArrays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>surfaceVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glGenBuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>surfaceVBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>surfaceVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> surfaceVBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>surface<span class="token punctuation">,</span> GL_STATIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建一个帧缓冲对象：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> FBO<span class="token punctuation">;</span>
<span class="token function">glGenFramebuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>FBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> FBO<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>创建一个纹理图像并绑定到当前帧缓冲对象：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> TBO<span class="token punctuation">;</span>
<span class="token function">glGenTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>TBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> TBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> GL_UNSIGNED_BYTE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glFramebufferTexture2D</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT0<span class="token punctuation">,</span> GL_TEXTURE_2D<span class="token punctuation">,</span> TBO<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建一个渲染缓冲对象让OpenGL 能够进行深度测试（模板测试）：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> RBO<span class="token punctuation">;</span>
<span class="token function">glGenRenderbuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>RBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindRenderbuffer</span><span class="token punctuation">(</span>GL_RENDERBUFFER<span class="token punctuation">,</span> RBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glRenderbufferStorage</span><span class="token punctuation">(</span>GL_RENDERBUFFER<span class="token punctuation">,</span> GL_DEPTH24_STENCIL8<span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">glFramebufferRenderbuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_DEPTH_STENCIL_ATTACHMENT<span class="token punctuation">,</span> GL_RENDERBUFFER<span class="token punctuation">,</span> RBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">glCheckFramebufferStatus</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">)</span> <span class="token operator">!=</span> GL_FRAMEBUFFER_COMPLETE<span class="token punctuation">)</span>
	<span class="token function">m_log</span><span class="token punctuation">(</span><span class="token string">"Framebuffer can't complete."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解绑帧缓冲：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>创建简单着色器绘制四边形屏幕：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> aPos<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> aTexCoords<span class="token punctuation">;</span>

<span class="token keyword">out</span> <span class="token keyword">vec2</span> TexCoords<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    gl_Position <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> aPos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    TexCoords <span class="token operator">=</span> aTexCoords<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">in</span> <span class="token keyword">vec2</span> TexCoords<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">sampler2D</span> surfaceTexture<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span> 
    FragColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>surfaceTexture<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>in rendering loop：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 绑定帧缓冲</span>
<span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> FBO<span class="token punctuation">)</span>
<span class="token function">glClearColor</span><span class="token punctuation">(</span><span class="token number">0.2f</span><span class="token punctuation">,</span> <span class="token number">0.3f</span><span class="token punctuation">,</span> <span class="token number">0.3f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT | GL_STENCIL_BUFFER_BIT);</span>
<span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT <span class="token operator">|</span> GL_DEPTH_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glEnable</span><span class="token punctuation">(</span>GL_DEPTH_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 绘制场景中的物体到帧缓冲中，绘制代码不变（之前绘制到默认帧缓冲中）</span>

<span class="token comment">// 解绑帧缓冲并清除</span>
<span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">glClearColor</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">glClear</span><span class="token punctuation">(</span>GL_COLOR_BUFFER_BIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 绘制屏幕</span>
surface_shader<span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>surfaceVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glDisable</span><span class="token punctuation">(</span>GL_DEPTH_TEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> TBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下图是效果（右边是线框模式，可以看出只绘制了两个三角形）。</p>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/FBO.png" / loading="lazy"></p>
<p><strong>后期处理</strong></p>
<p>负片：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token function">texture</span><span class="token punctuation">(</span>surfaceTexture<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>灰度：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">vec3</span> t <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>surfaceTexture<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
<span class="token keyword">float</span> gray <span class="token operator">=</span> <span class="token number">0.2126</span> <span class="token operator">*</span> t<span class="token punctuation">.</span>r <span class="token operator">+</span> <span class="token number">0.7152</span> <span class="token operator">*</span> t<span class="token punctuation">.</span>g <span class="token operator">+</span> <span class="token number">0.0722</span> <span class="token operator">*</span> t<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>gray<span class="token punctuation">,</span> gray<span class="token punctuation">,</span> gray<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>锐化(Sharpen)核：</p>
<blockquote>
<p>大部分核将所有权重加起来之后都应该会等于1，如果不等于1，最终的纹理颜色将会比原来更亮或者更暗。</p>
<p>核在对屏幕纹理的边缘进行采样的时候，还会对中心像素周围的 8 个像素进行采样，会取到纹理之外的像素。环绕方式默认是 GL_REPEAT，在没有设置的情况下取到的是屏幕另一边的像素，而另一边的像素本不应该对中心像素产生影响。因此可以将屏幕纹理的环绕方式设置为 <strong>GL_CLAMP_TO_EDGE</strong>。在取到纹理外的像素时，能重复边缘的像素来更精确地估计最终的值。</p>
</blockquote>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">const</span> <span class="token keyword">float</span> offset <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">300.0</span><span class="token punctuation">;</span>  

<span class="token keyword">const</span> <span class="token keyword">vec2</span> offsets<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>offset<span class="token punctuation">,</span>  offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>    offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> offset<span class="token punctuation">,</span>  offset<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>offset<span class="token punctuation">,</span>  <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>    <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token keyword">vec2</span><span class="token punctuation">(</span> offset<span class="token punctuation">,</span>  <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
    <span class="token keyword">vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>offset<span class="token punctuation">,</span> <span class="token operator">-</span>offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> <span class="token number">0.0f</span><span class="token punctuation">,</span>   <span class="token operator">-</span>offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec2</span><span class="token punctuation">(</span> offset<span class="token punctuation">,</span> <span class="token operator">-</span>offset<span class="token punctuation">)</span>  
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">float</span> kernel<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> 
<span class="token punctuation">&#123;</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">9</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">vec3</span> sampleTex<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        sampleTex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token function">texture</span><span class="token punctuation">(</span>surfaceTexture<span class="token punctuation">,</span> TexCoords<span class="token punctuation">.</span>st <span class="token operator">+</span> offsets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">vec3</span> col <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        col <span class="token operator">+=</span> sampleTex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> kernel<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>模糊核：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">const</span> <span class="token keyword">float</span> kernel<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> 
<span class="token punctuation">&#123;</span>
    <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span>
    <span class="token number">2.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">4.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span>
    <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span>  
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>边缘检测(Edge-detection)核：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">const</span> <span class="token keyword">float</span> kernel<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> 
<span class="token punctuation">&#123;</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Soble边缘检测：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">// 水平梯度/垂直轮廓</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> kernel<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">&#123;</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 垂直梯度/水平轮廓    </span>
<span class="token keyword">const</span> <span class="token keyword">float</span> kernel<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">&#123;</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/post_processing.png" / loading="lazy"></p>
<h2 id="cubemap">Cubemap</h2>
<p>立方体贴图（Cubemap）是一个有 6 个 2D 纹理的纹理。</p>
<p>立方体贴图创建要绑定到 <strong>GL_TEXTURE_CUBE_MAP</strong>。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> cubemap<span class="token punctuation">;</span>
<span class="token function">glGenTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cubemap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_CUBE_MAP<span class="token punctuation">,</span> cubemap<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>调用 <code>glTexImage2D</code> 函数 6 次为每个面添加贴图。OpenGL 提供 6 个特殊纹理目标，对应立方体贴图的 6 个面。</p>
<blockquote>
<ul>
<li>GL_TEXTURE_CUBE_MAP_POSITIVE_X 右</li>
<li>GL_TEXTURE_CUBE_MAP_NEGATIVE_X 左</li>
<li>GL_TEXTURE_CUBE_MAP_POSITIVE_Y 上</li>
<li>GL_TEXTURE_CUBE_MAP_NEGATIVE_Y 下</li>
<li>GL_TEXTURE_CUBE_MAP_POSITIVE_Z 后</li>
<li>GL_TEXTURE_CUBE_MAP_NEGATIVE_Z 前</li>
</ul>
</blockquote>
<p>下面是加载立方体贴图的函数实现：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> <span class="token function">m_load_img3D</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> paths<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">const</span> size_t N <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token keyword">bool</span> flip_verticlal <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> texture<span class="token punctuation">;</span>
	<span class="token function">glGenTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_CUBE_MAP<span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">stbi_set_flip_vertically_on_load</span><span class="token punctuation">(</span>flip_verticlal<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> channels<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> data <span class="token operator">=</span> <span class="token function">stbi_load</span><span class="token punctuation">(</span>paths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>width<span class="token punctuation">,</span> <span class="token operator">&amp;</span>height<span class="token punctuation">,</span> <span class="token operator">&amp;</span>channels<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span>
		<span class="token punctuation">&#123;</span>
			GLenum format <span class="token operator">=</span> <span class="token function">get_format</span><span class="token punctuation">(</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_CUBE_MAP_POSITIVE_X <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> GL_UNSIGNED_BYTE<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">stbi_image_free</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">&#123;</span>
			<span class="token function">stbi_image_free</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_LOG</span></span>
			<span class="token function">m_log</span><span class="token punctuation">(</span><span class="token string">"Failed to load texture!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">m_log</span><span class="token punctuation">(</span>paths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_CUBE_MAP<span class="token punctuation">,</span> GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_CUBE_MAP<span class="token punctuation">,</span> GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span> GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_CUBE_MAP<span class="token punctuation">,</span> GL_TEXTURE_WRAP_S<span class="token punctuation">,</span> GL_CLAMP_TO_EDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_CUBE_MAP<span class="token punctuation">,</span> GL_TEXTURE_WRAP_T<span class="token punctuation">,</span> GL_CLAMP_TO_EDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_CUBE_MAP<span class="token punctuation">,</span> GL_TEXTURE_WRAP_R<span class="token punctuation">,</span> GL_CLAMP_TO_EDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> texture<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>渲染天空盒小优化</strong></p>
<p>先渲染天空盒，会对屏幕上的每一个像素运行一遍片段着色器，即使只有小部分的天空盒最终是可见的。</p>
<p>最后渲染天空盒，深度缓冲会填充满所有物体的深度值，只需要在提前深度测试通过的地方渲染天空盒的片段就可以了，减少了片段着色器的调用。</p>
<p>问题是，天空盒只是一个 1x1x1 的立方体，会不通过大部分的深度测试，导致渲染失败。</p>
<p>注意到<strong>透视除法</strong>是在顶点着色器运行之后执行的，将 <code>gl_Position</code> 的<code>xyz</code>坐标除以 <code>w</code> 分量，结果 <code>z</code> 分量是顶点深度值。让输出的 <code>z</code> 分量等于 <code>w</code> 分量，当执行透视除法后，<code>z</code> 分量会变为<code>w / w = 1.0</code>，即最大的深度值，天空盒只会在没有可见物体的地方渲染。(<code>samplerCube</code> 用于片段着色器采样立方体贴图)</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aPos<span class="token punctuation">;</span>

<span class="token keyword">out</span> <span class="token keyword">vec3</span> TexCoords<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> projection<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> view<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    TexCoords <span class="token operator">=</span> aPos<span class="token punctuation">;</span>
    <span class="token keyword">vec4</span> pos <span class="token operator">=</span> projection <span class="token operator">*</span> view <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> pos<span class="token punctuation">.</span>xyww<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>  

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">in</span> <span class="token keyword">vec3</span> TexCoords<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">samplerCube</span> skybox<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>    
    FragColor <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>skybox<span class="token punctuation">,</span> TexCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>深度缓冲将会填充上天空盒1.0 的值，深度函数从默认的 <strong>GL_LESS</strong> 改为<strong>GL_LEQUAL</strong>，保证天空盒在值小于或等于深度缓冲而不是小于时通过深度测试，渲染完成后改回 <strong>GL_LESS</strong> 。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glDepthFunc</span><span class="token punctuation">(</span>GL_LEQUAL<span class="token punctuation">)</span><span class="token punctuation">;</span>  
skybox_shader<span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
view <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">mat4</span><span class="token punctuation">(</span>glm<span class="token operator">::</span><span class="token function">mat3</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span><span class="token function">getViewMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
skybox_shader<span class="token punctuation">.</span><span class="token function">setMat4</span><span class="token punctuation">(</span><span class="token string">"view"</span><span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span>
skybox_shader<span class="token punctuation">.</span><span class="token function">setMat4</span><span class="token punctuation">(</span><span class="token string">"projection"</span><span class="token punctuation">,</span> projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>skyboxVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glActiveTexture</span><span class="token punctuation">(</span>GL_TEXTURE0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_CUBE_MAP<span class="token punctuation">,</span> skybox_cubemap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glDepthFunc</span><span class="token punctuation">(</span>GL_LESS<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>不希望移动影响天空盒子，因此设置矩阵第四个维度为0。</p>
<p><code>view = glm::mat4(glm::mat3(camera.getViewMat()));</code></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/skybox.png" style="zoom:50%;" / loading="lazy"></p>
<p><strong>反射</strong></p>
<p>在物体的片段着色器上，根据观察向量 <code>D</code>、物体法向量 <code>N</code> 来计算反射向量 <code>R</code>。( <code>reflect</code> 函数)</p>
<p>需要物体有法向量，并更新物体的顶点着色器和片段着色器。</p>
<p>Position 输出向量是一个世界空间的位置向量，用来在片段着色器内计算观察方向向量。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aPos<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aNormal<span class="token punctuation">;</span>

<span class="token keyword">out</span> <span class="token keyword">vec3</span> Normal<span class="token punctuation">;</span>
<span class="token keyword">out</span> <span class="token keyword">vec3</span> Position<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> model<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> view<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> projection<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    Normal <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token function">inverse</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> aNormal<span class="token punctuation">;</span>
    Position <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> projection <span class="token operator">*</span> view <span class="token operator">*</span> model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">in</span> <span class="token keyword">vec3</span> Normal<span class="token punctuation">;</span>
<span class="token keyword">in</span> <span class="token keyword">vec3</span> Position<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">vec3</span> cameraPos<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">samplerCube</span> skybox<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>    
    <span class="token keyword">vec3</span> D <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>Position <span class="token operator">-</span> cameraPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> R <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span>D<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>Normal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token function">texture</span><span class="token punctuation">(</span>skybox<span class="token punctuation">,</span> R<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>渲染物体之前要绑定立方体贴图：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>mirrorVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glActiveTexture</span><span class="token punctuation">(</span>GL_TEXTURE0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_CUBE_MAP<span class="token punctuation">,</span> skybox_cubemap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/reflect.png" alt="reflect" style="zoom:50%;" / loading="lazy"></p>
<p>不需要改变 skybox。</p>
<p><strong>折射</strong></p>
<p>修改下片段着色器即可。(<code>refract</code> 函数)</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">float</span> refractive_index <span class="token operator">=</span> <span class="token number">1.00</span> <span class="token operator">/</span> <span class="token number">1.55</span><span class="token punctuation">;</span>
<span class="token keyword">vec3</span> D <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>Position <span class="token operator">-</span> cameraPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">vec3</span> R <span class="token operator">=</span> <span class="token function">refract</span><span class="token punctuation">(</span>D<span class="token punctuation">,</span> <span class="token function">normalize</span><span class="token punctuation">(</span>Normal<span class="token punctuation">)</span><span class="token punctuation">,</span> refractive_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token function">texture</span><span class="token punctuation">(</span>skybox<span class="token punctuation">,</span> R<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="buffer">Buffer</h2>
<p>OpenGL 的缓冲是管理特定内存块的对象，需要绑定到对应的缓冲目标。</p>
<ul>
<li>绑定到 GL_ARRAY_BUFFER：顶点数组缓冲。</li>
<li>绑定到 GL_ELEMENT_ARRAY_BUFFER：顶点索引缓冲。</li>
</ul>
<p>OpenGL内部会为每个目标储存一个缓冲，根据目标的不同，以不同的方式处理缓冲。</p>
<p><strong>数据导入缓冲区</strong></p>
<p><code>glBufferData</code> ：填充缓冲对象所管理的内存，如果设置 data 为 <strong>NULL</strong>，只分配内存，不进行填充。</p>
<p><code>glBufferSubData</code>填充缓冲特定区域：</p>
<ul>
<li>可以指定偏移量。</li>
<li>确保有足够的内存分配（先调用 <code>glBufferData</code>）。</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBufferSubData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//[16, 16 + sizeof(data)]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>调用 <code>glMapBuffer</code> 函数返回当前绑定缓冲的内存指针：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// 绑定缓冲区</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> VBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取</span>
<span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token function">glMapBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> GL_WRITE_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 内存拷贝</span>
<span class="token function">memcpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 解除内存指针绑定，ptr不再可用</span>
<span class="token function">glUnmapBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>直接映射数据到缓冲（比如从文件中读取数据，并直接复制到内存缓冲中），可以用 <code>glMapBuffer</code>。</p>
</blockquote>
<p><strong>顶点属性分批</strong></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">float</span> positions<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> normals<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> texCoords<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token function">glBufferSubData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>positions<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>positions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBufferSubData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>positions<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>normals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>normals<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBufferSubData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>positions<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>normals<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                <span class="token keyword">sizeof</span><span class="token punctuation">(</span>texCoords<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>texCoords<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>positions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                      <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>positions<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>normals<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>缓冲复制</strong></p>
<p>使用 <code>glCopyBufferSubData</code> 把一个缓冲中的数据复制到另一个缓冲中：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">glCopyBufferSubData</span><span class="token punctuation">(</span>GLenum readtarget<span class="token punctuation">,</span> GLenum writetarget<span class="token punctuation">,</span> 
                         GLintptr readoffset<span class="token punctuation">,</span> GLintptr writeoffset<span class="token punctuation">,</span> GLsizeiptr size<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<ul>
<li>readtarget：源缓冲目标（比如 VERTEX_ARRAY_BUFFER）。</li>
<li>writetarget：目标缓冲目标（比如 VERTEX_ELEMENT_ARRAY_BUFFER）。</li>
<li>readoffset：源偏移量。</li>
<li>writeoffset：目标偏移量。</li>
<li>size：数据大小。</li>
</ul>
</blockquote>
<p>读写数据的两个不同缓冲都为顶点数组缓冲：<strong>GL_COPY_READ_BUFFER</strong> 和 <strong>GL_COPY_WRITE_BUFFER</strong>。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">float</span> vertex_data<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">// 1</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_COPY_READ_BUFFER<span class="token punctuation">,</span> VBO1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_COPY_WRITE_BUFFER<span class="token punctuation">,</span> VBO2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glCopyBufferSubData</span><span class="token punctuation">(</span>GL_COPY_READ_BUFFER<span class="token punctuation">,</span> GL_COPY_WRITE_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>vertex_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> VBO1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_COPY_WRITE_BUFFER<span class="token punctuation">,</span> VBO2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glCopyBufferSubData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> GL_COPY_WRITE_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>vertex_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="advanced-glsl">Advanced GLSL</h2>
<p><strong>内建变量(Built-in Variable)</strong></p>
<p>顶点着色器：</p>
<blockquote>
<ul>
<li><p>gl_Position：（输出变量）裁剪空间输出位置向量。</p></li>
<li><p>gl_PointSize：（输出变量）顶点着色器中修改点大小的功能默认是禁用的，启用方法如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_PROGRAM_POINT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>点的大小设置为裁剪空间位置的 z 值，即顶点距观察者的距离，它会随着观察者距顶点距离变远而变大。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">gl_Position <span class="token operator">=</span> projection <span class="token operator">*</span> view <span class="token operator">*</span> model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
gl_PointSize <span class="token operator">=</span> gl_Position<span class="token punctuation">.</span>z<span class="token punctuation">;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这个可以用来做粒子特效。</p></li>
<li><p>gl_VertexID：（输入变量）储存了正在绘制的顶点 ID。</p></li>
</ul>
</blockquote>
<p>片段着色器：</p>
<blockquote>
<ul>
<li><p>gl_FragCoord：（只读变量）在片段着色器中，x、y 为片段屏幕空间坐标，z 是片段深度值。</p>
<p>可以对比不同片段计算的视觉输出效果。</p></li>
<li><p>gl_FrontFacing：当前片段是属于正向面的一部分还是背向面的一部分。</p>
<p>可以用来输出正面和背面不同的效果。</p></li>
<li><p>gl_FragDepth：在着色器内设置片段深度值，会禁用所有的提前深度测试。</p>
<p><strong>OpenGL 4.2</strong> 起，在片段着色器的顶部使用深度条件重新声明 gl_FragDepth 变量：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">layout</span> <span class="token punctuation">(</span>depth_<span class="token operator">&lt;</span>condition<span class="token operator">></span><span class="token punctuation">)</span> out <span class="token keyword">float</span> gl_FragDepth<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>any：默认值，禁用提前深度测试，会损失很多性能。</li>
<li>greater：只能让深度值比 <code>gl_FragCoord.z</code> 更大。</li>
<li>less：只能让深度值比 <code>gl_FragCoord.z</code>更小。</li>
<li>unchanged：要写入 <code>gl_FragDepth</code>，只能写入 <code>gl_FragCoord.z</code> 的值。</li>
</ul></li>
</ul>
</blockquote>
<p><strong>接口块</strong></p>
<p>用 in 或 out 关键字来定义。只要两个接口块的名字一样，对应的输入和输出会匹配起来。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">out</span> VS_OUT
<span class="token punctuation">&#123;</span>
    <span class="token keyword">vec2</span> TexCoords<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> Normal<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> vs_out<span class="token punctuation">;</span>

<span class="token keyword">in</span> VS_OUT
<span class="token punctuation">&#123;</span>
    <span class="token keyword">vec2</span> TexCoords<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> Normal<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> fs_in<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>uniform缓冲对象(Uniform Buffer Object)</strong></p>
<p>UBO 允许定义一系列在多个着色器中相同的全局Uniform变量，使用 UBO 只需要设置相关uniform 一次。</p>
<p>UBO 是一个缓冲，使用 <code>glGenBuffers</code> 创建，绑定到 <strong>GL_UNIFORM_BUFFER</strong> 缓冲目标。</p>
<p>使用顶点着色器，将 projection 和 view 存储到 Uniform 块中：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">layout</span> <span class="token punctuation">(</span>std140<span class="token punctuation">)</span> <span class="token keyword">uniform</span> Matrices
<span class="token punctuation">&#123;</span>
    <span class="token keyword">mat4</span> projection<span class="token punctuation">;</span>
    <span class="token keyword">mat4</span> view<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之前在每个渲染迭代中，对每个着色器设置 projection 和 view 的 Uniform 矩阵。</p>
<p>利用 UBO，只需要存储这些矩阵一次。声明了 Matrices 的 Uniform 块，Uniform 块中的变量可以直接访问，不需要加块名为前缀。OpenGL 代码中将矩阵值存入缓冲中，每个声明了这个Uniform 块的着色器都能够访问这些矩阵。</p>
<p>Uniform 块的内容是储存在一个缓冲对象中的，实际上只是一块预留内存。需要告诉 OpenGL 内存的哪一部分对应着色器中的哪一个 uniform 变量。</p>
<blockquote>
<p><code>layout (std140)</code>当前定义的 Uniform 块对它的内容使用一个特定的内存布局。std140 布局声明了每个变量的偏移量都是由一系列规则所决定的，声明了每个变量类型的内存布局。</p>
<p>td140 布局不是最高效的布局，但保证了内存布局在每个声明了这个 Uniform 块的程序中是一致的。</p>
<p>还有 <code>shared</code> 和 <code>packed</code> 布局，这里不赘述。</p>
</blockquote>
<p><strong>基准对齐量</strong>(Base Alignment)等于一个变量在 Uniform 块中所占据的空间（包括填充量(Padding)）。</p>
<p><strong>对齐偏移量</strong>(Aligned Offset)是一个变量从块起始位置的字节偏移量，必须是基准对齐量的倍数。</p>
<blockquote>
<p>每个变量（int、float和bool）被定义为 4 字节量，令 <strong>N = 4</strong> 。</p>
<ul>
<li>标量：基准对齐量 N。</li>
<li>向量：2N 或 4N（vec3）。</li>
<li>标量数组或向量数组：与 vec4 相同。</li>
<li>矩阵：储存为列向量的数组，向量基准对齐量与 vec4 相同。</li>
<li>结构体：所有元素根据规则计算后的大小，会填充到 vec4 大小的倍数。</li>
</ul>
</blockquote>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">layout</span> <span class="token punctuation">(</span>std140<span class="token punctuation">)</span> <span class="token keyword">uniform</span> M_Block	
<span class="token punctuation">&#123;</span>				     <span class="token comment">// total 152</span>
                     <span class="token comment">// 基准对齐量       // 对齐偏移量</span>
    <span class="token keyword">float</span> value<span class="token punctuation">;</span>     <span class="token comment">// 4               // 0 </span>
    <span class="token keyword">vec3</span> vector<span class="token punctuation">;</span>     <span class="token comment">// 16              // 16  (16的倍数，所以 4->16)</span>
    <span class="token keyword">mat4</span> matrix<span class="token punctuation">;</span>     <span class="token comment">// 16              // 32  (列 0)</span>
                     <span class="token comment">// 16              // 48  (列 1)</span>
                     <span class="token comment">// 16              // 64  (列 2)</span>
                     <span class="token comment">// 16              // 80  (列 3)</span>
    <span class="token keyword">float</span> values<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 16              // 96  (values[0])</span>
                     <span class="token comment">// 16              // 112 (values[1])</span>
                     <span class="token comment">// 16              // 128 (values[2])</span>
    <span class="token keyword">bool</span> boolean<span class="token punctuation">;</span>    <span class="token comment">// 4               // 144</span>
    <span class="token keyword">int</span> integer<span class="token punctuation">;</span>     <span class="token comment">// 4               // 148</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 UBO，调用 <code>glGenBuffers</code> 创建 UBO，并绑定到 <strong>GL_UNIFORM_BUFFER</strong>，再用 <code>glBufferData</code> 分配内存。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> UBO<span class="token punctuation">;</span>
<span class="token function">glGenBuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>UBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> UBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">152</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> GL_STATIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要对缓冲更新或者插入数据，绑定到对应 UBO，用 <code>glBufferSubData</code>更新内存。</p>
<p>在 OpenGL 上下文中，定义了一些绑定点(Binding Point)，可以将一个 Uniform 缓冲链接至它，并将着色器中的Uniform 块绑定到相同的绑定点，把它们连接到一起。</p>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/binding_points.png" alt="binding_points" style="zoom: 80%;" / loading="lazy"></p>
<p>将图中的 Lights Uniform 块链接到绑定点2：(需要对每个着色器重复这一步骤)</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> lights_index <span class="token operator">=</span> <span class="token function">glGetUniformBlockIndex</span><span class="token punctuation">(</span>shaderA<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">"Lights"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token function">glUniformBlockBinding</span><span class="token punctuation">(</span>shaderA<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> lights_index<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<p>OpenGL 4.2起，可以添加一个布局标识符，显式地将 Uniform 块的绑定点储存在着色器中。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">layout</span><span class="token punctuation">(</span>std140<span class="token punctuation">,</span> binding <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">uniform</span> Lights <span class="token punctuation">&#123;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</blockquote>
<p>绑定UBO 到相同的绑定点上：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBindBufferBase</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> UBO<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// or</span>
<span class="token function">glBindBufferRange</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> UBO<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">152</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>用以下方式更新 Uniform 缓冲对象：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> UBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// GLSL bool 4 byte.</span>
<span class="token function">glBufferSubData</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">144</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>示例</strong></p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aPos<span class="token punctuation">;</span>

<span class="token keyword">layout</span> <span class="token punctuation">(</span>std140<span class="token punctuation">)</span> <span class="token keyword">uniform</span> Matrices
<span class="token punctuation">&#123;</span>
    <span class="token keyword">mat4</span> projection<span class="token punctuation">;</span>
    <span class="token keyword">mat4</span> view<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> model<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    gl_Position <span class="token operator">=</span> projection <span class="token operator">*</span> view <span class="token operator">*</span> model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>模型矩阵在不同的着色器中会不断改变，使用Uniform缓冲对象并不方便。</p>
</blockquote>
<p>创建UBO，并绑定到绑定点0。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> UBO<span class="token punctuation">;</span>
<span class="token function">glGenBuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>UBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> UBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>glm<span class="token operator">::</span>mat4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> GL_STATIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBufferRange</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> UBO<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>glm<span class="token operator">::</span>mat4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>顶点着色器 Uniform 块设置为绑定点0。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">unsigned</span> uidx1 <span class="token operator">=</span> <span class="token function">glGetUniformBlockIndex</span><span class="token punctuation">(</span>shader1<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">"Matrices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> uidx2 <span class="token operator">=</span> <span class="token function">glGetUniformBlockIndex</span><span class="token punctuation">(</span>shader2<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">"Matrices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glUniformBlockBinding</span><span class="token punctuation">(</span>shader1<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> uidx1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glUniformBlockBinding</span><span class="token punctuation">(</span>shader2<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> uidx2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 <code>glBufferSubData</code> 在进入rendering loop 前存储投影矩阵。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">glm<span class="token operator">::</span>mat4 projection <span class="token operator">=</span> glm<span class="token operator">::</span><span class="token function">perspective</span><span class="token punctuation">(</span>glm<span class="token operator">::</span><span class="token function">radians</span><span class="token punctuation">(</span><span class="token number">45.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span> width<span class="token operator">/</span>height<span class="token punctuation">,</span> <span class="token number">0.1f</span><span class="token punctuation">,</span> <span class="token number">100.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> UBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBufferSubData</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>glm<span class="token operator">::</span>mat4<span class="token punctuation">)</span><span class="token punctuation">,</span> glm<span class="token operator">::</span><span class="token function">value_ptr</span><span class="token punctuation">(</span>projection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>每次渲染迭代中绘制物体之前，将观察矩阵更新到缓冲的后半部分。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">glm<span class="token operator">::</span>mat4 view <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">GetViewMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> UBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBufferSubData</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>glm<span class="token operator">::</span>mat4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>glm<span class="token operator">::</span>mat4<span class="token punctuation">)</span><span class="token punctuation">,</span> glm<span class="token operator">::</span><span class="token function">value_ptr</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_UNIFORM_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><strong>UBO 的优势</strong></p>
<ul>
<li>一次设置多个 uniform 会比一个个设置 uniform 快。</li>
<li>在 Uniform 缓冲中修改一次 uniform 比在多个着色器中修改同样的 uniform 更容易。</li>
<li>OpenGL 限制了最多能处理的 uniform 数量，通过 <strong>GL_MAX_VERTEX_UNIFORM_COMPONENTS</strong> 查询，使用 UBO 数量会更多。</li>
</ul>
</blockquote>
<h2 id="geometry-shader">Geometry Shader</h2>
<p>几何着色器(Geometry Shader) 在顶点和片段着色器之间，输入是一个图元的一组顶点，它能够将顶点变换为完全不同的图元，还能生成比原来更多的顶点。</p>
<p>几何着色器顶部，声明从顶点着色器输入的图元类型。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">layout</span> <span class="token punctuation">(</span>points<span class="token punctuation">)</span> <span class="token keyword">in</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<ul>
<li><code>points</code>：绘制 GL_POINTS。（1）</li>
<li>‘<code>lines</code>：绘制 GL_LINES 或 GL_LINE_STRIP。（2）</li>
<li><code>lines_adjacency</code>：GL_LINES_ADJACENCY 或 GL_LINE_STRIP_ADJACENCY。（4）</li>
<li><code>triangles</code>：GL_TRIANGLES、GL_TRIANGLE_STRIP 或 GL_TRIANGLE_FAN。（3）</li>
<li><code>triangles_adjacency</code>：GL_TRIANGLES_ADJACENCY、GL_TRIANGLES_ADJACENCY 或GL_TRIANGLE_STRIP_ADJACENCY。（6）</li>
</ul>
<p>（）里面的数字是一个图元包含的最少顶点数。</p>
</blockquote>
<p>声明几何着色器输出的图元类型，并设置最多输出的顶点数量。</p>
<blockquote>
<ul>
<li><code>points</code></li>
<li><code>line_strip</code></li>
<li><code>triangle_strip</code></li>
</ul>
</blockquote>
<p>GLSL 提供内建变量（几何着色器输入是一个图元所有顶点，一般多于 1 个，因此被声明为一个数组）。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">in</span> gl_Vertex
<span class="token punctuation">&#123;</span>
    <span class="token keyword">vec4</span>  gl_Position<span class="token punctuation">;</span>
    <span class="token keyword">float</span> gl_PointSize<span class="token punctuation">;</span>
    <span class="token keyword">float</span> gl_ClipDistance<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> gl_in<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>几何着色器的使用</strong></p>
<p>准备四个点（不需要 z 方向坐标）：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">const</span> <span class="token keyword">float</span> points<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//  position   color</span>
    <span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span>  <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> 
     <span class="token number">0.5f</span><span class="token punctuation">,</span>  <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> 
     <span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> 
    <span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span>  
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>顶点着色器</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> aPos<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aColor<span class="token punctuation">;</span>

<span class="token keyword">out</span> VS_OUT <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec3</span> v_color<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> vs_out<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    gl_Position <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> aPos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    vs_out<span class="token punctuation">.</span>v_color <span class="token operator">=</span> aColor<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在几何着色器上绘制图案（几何着色器编译链接与其他着色器一样）：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>points<span class="token punctuation">)</span> <span class="token keyword">in</span><span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>triangle_strip<span class="token punctuation">,</span> max_vertices <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">out</span><span class="token punctuation">;</span>

<span class="token keyword">in</span> VS_OUT <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec3</span> v_color<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> gs_in<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">out</span> <span class="token keyword">vec3</span> g_color<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">float</span> scale <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>    
    g_color <span class="token operator">=</span> gs_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v_color<span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> gl_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position <span class="token operator">+</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token operator">-</span>scale<span class="token punctuation">,</span> <span class="token operator">-</span>scale<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_color <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    gl_Position <span class="token operator">=</span> gl_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position <span class="token operator">+</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span> scale<span class="token punctuation">,</span> <span class="token operator">-</span>scale<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     g_color <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> gl_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position <span class="token operator">+</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token operator">-</span>scale<span class="token punctuation">,</span>  scale<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_color <span class="token operator">=</span> gs_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v_color<span class="token punctuation">;</span>
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> gl_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position <span class="token operator">+</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span> scale<span class="token punctuation">,</span>  scale<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    g_color <span class="token operator">=</span> gs_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>v_color<span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> gl_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position <span class="token operator">+</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span> <span class="token number">0.0</span><span class="token punctuation">,</span>  <span class="token number">2</span> <span class="token operator">*</span> scale<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// top point color </span>
    g_color <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EndPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>调用 <code>EmitVertex</code> 时，<strong>gl_Position </strong>向量会被添加到图元中。调用 <code>EndPrimitive</code> 时，发射出的(Emitted)顶点会合成为指定输出渲染图元。 <code>EmitVertex</code> 调用之后重复调用<code>EndPrimitive</code> 能够生成多个图元。</p>
</blockquote>
<p>片段着色器</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">in</span> <span class="token keyword">vec3</span> g_color<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>g_color<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<figure>
<img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/geometry.png" alt="image-20210316185435057" / loading="lazy"><figcaption>image-20210316185435057</figcaption>
</figure>
<p><strong>物体爆炸</strong></p>
<p>把每个三角形沿着法向量的方向移动一小段距离。</p>
<p>使用 3 个输入顶点坐标来获取法向量，使用<strong>叉乘</strong>来获取垂直于其它两个向量的一个向量：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">vec3</span> <span class="token function">get_normal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
   <span class="token keyword">vec3</span> a <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>gl_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>gl_in<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">vec3</span> b <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>gl_in<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>gl_in<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>用法向量和顶点位置向量作为参数，会返回一个新的向量，即位置向量沿着法线向量进行位移之后的结果。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">vec4</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token keyword">vec4</span> position<span class="token punctuation">,</span> <span class="token keyword">vec3</span> normal<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> magnitude <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> direction <span class="token operator">=</span> normal <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> magnitude<span class="token punctuation">;</span> 
    <span class="token keyword">return</span> position <span class="token operator">+</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>direction<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>完整的物体爆炸几何着色器</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>triangles<span class="token punctuation">)</span> <span class="token keyword">in</span><span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>triangle_strip<span class="token punctuation">,</span> max_vertices <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">out</span><span class="token punctuation">;</span>

<span class="token keyword">in</span> VS_OUT <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec2</span> texCoords<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> gs_in<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">out</span> <span class="token keyword">vec2</span> TexCoords<span class="token punctuation">;</span> 

<span class="token comment">// shader.setFloat("time", glfwGetTime());</span>
<span class="token keyword">uniform</span> <span class="token keyword">float</span> time<span class="token punctuation">;</span>

<span class="token keyword">vec3</span> <span class="token function">get_normal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
   <span class="token keyword">vec3</span> a <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>gl_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>gl_in<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">vec3</span> b <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>gl_in<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>gl_in<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">vec4</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token keyword">vec4</span> position<span class="token punctuation">,</span> <span class="token keyword">vec3</span> normal<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> magnitude <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> direction <span class="token operator">=</span> normal <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> magnitude<span class="token punctuation">;</span> 
    <span class="token keyword">return</span> position <span class="token operator">+</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>direction<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    
    <span class="token keyword">vec3</span> normal <span class="token operator">=</span> <span class="token function">get_normal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span>gl_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    TexCoords <span class="token operator">=</span> gs_in<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>texCoords<span class="token punctuation">;</span>
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span>gl_in<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    TexCoords <span class="token operator">=</span> gs_in<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>texCoords<span class="token punctuation">;</span>
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span>gl_in<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">,</span> normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    TexCoords <span class="token operator">=</span> gs_in<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>texCoords<span class="token punctuation">;</span>
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EndPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>法向量可视化</strong></p>
<p>使用模型提供的顶点法线</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aPos<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aNormal<span class="token punctuation">;</span>

<span class="token keyword">out</span> VS_OUT <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec3</span> normal<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> vs_out<span class="token punctuation">;</span>

<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> projection<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> view<span class="token punctuation">;</span>
<span class="token keyword">uniform</span> <span class="token keyword">mat4</span> model<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    gl_Position <span class="token operator">=</span> projection <span class="token operator">*</span> view <span class="token operator">*</span> model <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">mat3</span> normalMatrix <span class="token operator">=</span> <span class="token keyword">mat3</span><span class="token punctuation">(</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token function">inverse</span><span class="token punctuation">(</span>view <span class="token operator">*</span> model<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vs_out<span class="token punctuation">.</span>normal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>projection <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>normalMatrix <span class="token operator">*</span> aNormal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>几何着色器会接收每一个顶点（包括一个位置向量和一个法向量），并在每个位置向量处绘制一个法线向量：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>triangles<span class="token punctuation">)</span> <span class="token keyword">in</span><span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>line_strip<span class="token punctuation">,</span> max_vertices <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token keyword">out</span><span class="token punctuation">;</span>

<span class="token keyword">in</span> VS_OUT <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec3</span> normal<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> gs_in<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">float</span> MAGNITUDE <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">draw_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    gl_Position <span class="token operator">=</span> gl_in<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position<span class="token punctuation">;</span>
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl_Position <span class="token operator">=</span> gl_in<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>gl_Position <span class="token operator">+</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>gs_in<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> MAGNITUDE<span class="token punctuation">;</span>
    <span class="token function">EmitVertex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">EndPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">draw_line</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">draw_line</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">draw_line</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用片段着色器，将其显示为单色的线。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>该几何着色器也经常用于给物体添加毛发。</p>
</blockquote>
<h2 id="instancing">Instancing</h2>
<p>将数据一次性发送给 GPU，使用一个绘制函数让 OpenGL 利用这些数据绘制多个物体，即实例化(Instancing)。</p>
<ul>
<li><code>glDrawArrays</code> ：<code>glDrawArraysInstanced</code></li>
<li><code>glDrawElements</code>：<code>glDrawElementsInstanced</code></li>
</ul>
<p>渲染函数实例化版本需要一个额外的参数，实例数量来设置需要渲染的实例个数。GPU 会直接渲染实例，而不用频繁地与 CPU 进行通信。</p>
<p>GLSL 在顶点着色器中嵌入了一个内建变量 <strong>gl_InstanceID</strong>，从0开始，在每个实例被渲染时递增 1。</p>
<p><strong>实例化数组</strong></p>
<p>定义为一个顶点属性，仅在顶点着色器渲染一个新的实例时才会更新。</p>
<p>实例位置：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">glm<span class="token operator">::</span>vec2 translations<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> offset <span class="token operator">=</span> <span class="token number">0.1f</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> y <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> x <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        glm<span class="token operator">::</span>vec2 translation<span class="token punctuation">;</span>
        translation<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>x <span class="token operator">/</span> <span class="token number">10.0f</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>
        translation<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>y <span class="token operator">/</span> <span class="token number">10.0f</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>
        translations<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> translation<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实例缓冲：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>quadVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> instanceVBO<span class="token punctuation">;</span>
<span class="token function">glGenBuffers</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>instanceVBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> instanceVBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBufferData</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>glm<span class="token operator">::</span>vec2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>translations<span class="token punctuation">,</span> GL_STATIC_DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glEnableVertexAttribArray</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glVertexAttribPointer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> GL_FALSE<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindBuffer</span><span class="token punctuation">(</span>GL_ARRAY_BUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glVertexAttribDivisor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><code>glVertexAttribDivisor</code>告诉 OpenGL 什么情况下更新顶点属性的内容至新一组数据。</p>
<ul>
<li>param1：顶点属性。</li>
<li>param2：属性除数。默认 0，在顶点着色器的每次迭代时更新顶点属性；设置为 n，染 n 个新实例的时候更新顶点属性。</li>
</ul>
</blockquote>
<p>顶点着色器：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> aPos<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec3</span> aColor<span class="token punctuation">;</span>
<span class="token keyword">layout</span> <span class="token punctuation">(</span>location <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> aOffset<span class="token punctuation">;</span>

<span class="token keyword">out</span> <span class="token keyword">vec3</span> v_color<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    gl_Position <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>aPos <span class="token operator">*</span> gl_InstanceID <span class="token operator">/</span> <span class="token number">100.0</span> <span class="token operator">+</span> aOffset<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v_color <span class="token operator">=</span> aColor<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>片段着色器：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">version</span> <span class="token expression"><span class="token number">330</span> core</span></span>
<span class="token keyword">out</span> <span class="token keyword">vec4</span> FragColor<span class="token punctuation">;</span>

<span class="token keyword">in</span> <span class="token keyword">vec3</span> v_color<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    FragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>v_color<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>绘制方式：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">shader<span class="token punctuation">.</span><span class="token keyword">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span>quadVAO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glDrawArraysInstanced</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">glBindVertexArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/instance.png" style="zoom:50%;" / loading="lazy"></p>
<h2 id="anti-aliasing">Anti Aliasing</h2>
<p>抗锯齿（Anti-aliasing）是为了产生更平滑的边缘。</p>
<p><strong>多重采样（Multisampling）</strong></p>
<p>光栅器将一个图元所有顶点作为输入，并将它转换为一系列的片段。顶点坐标与片段之间基本不会有一对一映射，因此光栅器需要以某种方式来决定每个顶点最终所在的片段（屏幕坐标）。</p>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/sample.png" style="zoom: 67%;" / loading="lazy"></p>
<p>多重采样是将单一采样点变为多个采样点，不使用像素中心的单一采样点，而是以特定图案排列的 4 个子采样点。用这些子采样点来决定像素的覆盖度，颜色缓冲的大小会随着子采样点的增加而增加。</p>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/sample1.png" / loading="lazy"></p>
<blockquote>
<p>采样点的数量可以是任意的，更多的采样点能带来更精确的覆盖率。</p>
</blockquote>
<p>MSAA（Multisample Anti-aliasing）工作方式：不管三角形覆盖了多少子采样点，每个图元中每个像素只运行一次片段着色器，片段着色器使用的顶点数据会插值到每个像素的中心，结果颜色被储存在每个被覆盖的子采样点中。</p>
<p>当颜色缓冲的子样本被图元的所有颜色填满时，所有的颜色会在每个像素内部平均化。</p>
<p><img src="https://raw.githubusercontent.com/morisa66/BlogImgs/master/opengl/2/sample2.png" style="zoom:67%;" / loading="lazy"></p>
<p><strong>MSAA in OpenGL</strong></p>
<p>在 OpenGL 中使用 MSAA，要使用一个能在每个像素中存储大于 1 个颜色值的颜色缓冲（多重采样为每个采样点储存一个颜色）。存储特定数量的多重采样样本的<strong>多重采样缓冲</strong>(Multisample Buffer)。</p>
<p>在创建窗口之前调用 <code>glfwWindowHint</code> 来完成。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glfwWindowHint</span><span class="token punctuation">(</span>GLFW_SAMPLES<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>调用<code>glfwCreateWindow</code>创建渲染窗口时，每个屏幕坐标就会使用一个包含 4 个子采样点的颜色缓冲。</p>
<blockquote>
<p>GLFW 会自动创建一个每像素 4 个子采样点的深度和样本缓冲，因此对应缓冲的大小都变为 4 倍。</p>
</blockquote>
<p>启用多重采样。</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token function">glEnable</span><span class="token punctuation">(</span>GL_MULTISAMPLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>离屏 MSAA</strong></p>
<p>用自己的帧缓冲进行离屏渲染，要动手生成多重采样缓冲。</p>
<p>创建支持储存多个采样点的纹理，使用 <code>glTexImage2DMultisample</code>，纹理目标 <strong>GL_TEXTURE_2D_MULTISAPLE</strong>。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D_MULTISAMPLE<span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// samples是采样个数，最后一个参数为GL_TRUE，图像对每个纹素使用相同的样本位置、相同数量的子采样点个数。</span>
<span class="token function">glTexImage2DMultisample</span><span class="token punctuation">(</span>GL_TEXTURE_2D_MULTISAMPLE<span class="token punctuation">,</span> samples<span class="token punctuation">,</span> GL_RGB<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> GL_TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D_MULTISAMPLE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 <code>glFramebufferTexture2D</code> 将多重采样纹理附加到帧缓冲上，纹理类型 <strong>GL_TEXTURE_2D_MULTISAMPLE</strong>。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glFramebufferTexture2D</span><span class="token punctuation">(</span>GL_FRAMEBUFFER<span class="token punctuation">,</span> GL_COLOR_ATTACHMENT0<span class="token punctuation">,</span>
                       GL_TEXTURE_2D_MULTISAMPLE<span class="token punctuation">,</span> texture<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>当前绑定的帧缓冲就有了一个纹理图像形式的多重采样颜色缓冲。</p>
<p>多重采样渲染缓冲对象：在指定（当前绑定的）渲染缓冲的内存存储时，将 <code>glRenderbufferStorage</code> 改为<code>glRenderbufferStorageMultisample</code>。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glRenderbufferStorageMultisample</span><span class="token punctuation">(</span>GL_RENDERBUFFER<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> GL_DEPTH24_STENCIL8<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>渲染到多重采样帧缓冲：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_READ_FRAMEBUFFER<span class="token punctuation">,</span> multisampledFBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBindFramebuffer</span><span class="token punctuation">(</span>GL_DRAW_FRAMEBUFFER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">glBlitFramebuffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> GL_COLOR_BUFFER_BIT<span class="token punctuation">,</span> GL_NEAREST<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>自定义抗锯齿算法</strong></p>
<p>将纹理 uniform 采样器设置为 <code>sampler2DMS</code></p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">uniform</span> <span class="token keyword">sampler2DMS</span> screenTextureMS<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>使用 <code>texelFetch</code> 获取每个子样本的颜色值：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">vec4</span> colorSample <span class="token operator">=</span> <span class="token function">texelFetch</span><span class="token punctuation">(</span>screenTextureMS<span class="token punctuation">,</span> TexCoords<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 第i+1子样本	</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">If it is useful, and you would like to help me, please Money🤡Money🤡Money🤡!</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="/imgs/pay/zfb.jpg"><img loading="lazy" src="/imgs/pay/zfb.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a href="/imgs/pay/wx.png"><img loading="lazy" src="/imgs/pay/wx.png" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>morisa</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://morisa66.github.io/2021/01/21/OpenGL2/" title="OpenGL 2">https://morisa66.github.io/2021/01/21/OpenGL2/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/02/01/PCA_SVD/" rel="prev" title="数据降维"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">数据降维</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/01/19/OpenGL1/" rel="next" title="OpenGL 1"><span class="post-nav-text">OpenGL 1</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> morisa</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.4.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.5.1</span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div></body></html>